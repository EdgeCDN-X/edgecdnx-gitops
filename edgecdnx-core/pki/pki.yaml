---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: edgecdnx-pki
  namespace: argocd
spec:
  goTemplate: true
  syncPolicy:
    preserveResourcesOnDeletion: false
  generators:
    - clusters:
        selector:
          matchExpressions:
            - key: edgecdnx.com/control
              operator: In
              values:
                - "true"
                - "yes"
  template:
    metadata:
      name: edgecdnx-pki{{ if ne .name "in-cluster" }}-{{.name}}{{ end }}
    spec:
      project: default
      sources:
        - chart: resource-thrower
          helm:
            releaseName: pki-root
            valuesObject:
              resources:
                - apiVersion: cert-manager.io/v1
                  kind: ClusterIssuer
                  metadata:
                    name: edgecdnx-pki
                    namespace: cert-manager
                  spec:
                    selfSigned: {}
                - apiVersion: cert-manager.io/v1
                  kind: Certificate
                  metadata:
                    name: edgecdnx-ca-analytics
                    namespace: analytics
                  spec:
                    isCA: true
                    commonName: "analytics.{{ .metadata.annotations.basedomain }}"
                    secretName: edgecdnx-root-ca-analytics
                    privateKey:
                      algorithm: ECDSA
                      size: 256
                    issuerRef:
                      name: edgecdnx-pki
                      kind: ClusterIssuer
                      group: cert-manager.io
                - apiVersion: cert-manager.io/v1
                  kind: Issuer
                  metadata:
                    name: analytics-tls-issuer
                    namespace: analytics
                  spec:
                    ca:
                      secretName: edgecdnx-root-ca-analytics
                - apiVersion: cert-manager.io/v1
                  kind: Certificate
                  metadata:
                    name: edgecdnx-ca-monitoring
                    namespace: monitoring
                  spec:
                    isCA: true
                    commonName: "prometheus.{{ .metadata.annotations.basedomain }}"
                    secretName: edgecdnx-root-ca-monitoring
                    privateKey:
                      algorithm: ECDSA
                      size: 256
                    issuerRef:
                      name: edgecdnx-pki
                      kind: ClusterIssuer
                      group: cert-manager.io
                - apiVersion: cert-manager.io/v1
                  kind: Issuer
                  metadata:
                    name: mon-tls-issuer
                    namespace: monitoring
                  spec:
                    ca:
                      secretName: edgecdnx-root-ca-monitoring
          repoURL: https://edgecdn-x.github.io/helm-charts
          targetRevision: 0.1.0
      destination:
        namespace: cert-manager
        server: "{{ .server }}"
      syncPolicy:
        automated:
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
          - ServerSideApply=true # Big controller.
      ignoreDifferences: []













